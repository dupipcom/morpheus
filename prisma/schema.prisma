// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  entries       Json?
  settings      Settings?
  analysis      Json?
  availableBalance  Float?
  usedBudget    Float?    @default(0)  // Percentage of budget allocated to lists (0-100)
  remainingBudget Float?  @default(100) // Percentage of budget remaining (0-100)
  profit        Float?    @default(0)
  stash         Float?    @default(0)
  equity        Float?   @default(0)
  totalEarnings Float?   @default(0)
  hint String?
  userId        String?   @unique
  lastLogin     DateTime?
  persons       Person[]
  things        Thing[]
  events        Event[]
  notes         Note[]
  comments      Comment[]
  likes         Like[]
  profile       Profile?
  charts        Chart[]
  friends       String[]  @db.ObjectId
  closeFriends  String[]  @db.ObjectId
  friendRequests String[] @db.ObjectId
}

model Person {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  name          String
  email         String?
  phone         String?
  userId        String    @db.ObjectId
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  interactionQuality Int? // Rating from 1-5
  visibility    Visibility @default(PRIVATE)
  profile       Profile?  @relation(fields: [profileId], references: [id])
  profileId     String?   @unique @db.ObjectId
  noteIds       String[]  @default([]) @db.ObjectId
  documentIds   String[]  @default([]) @db.ObjectId
}

model Thing {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  name          String
  userId        String    @db.ObjectId
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  interactionQuality Int? // Rating from 1-5
  visibility    Visibility @default(PRIVATE)
  noteIds       String[]  @default([]) @db.ObjectId
  documentIds   String[]  @default([]) @db.ObjectId
}

model Event {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  name          String
  userId        String    @db.ObjectId
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  impact        Int? // Rating from 1-5
  visibility    Visibility @default(PRIVATE)
  noteIds       String[]  @default([]) @db.ObjectId
  documentIds   String[]  @default([]) @db.ObjectId
  comments      Comment[]
}

model Profile {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  userId        String    @unique @db.ObjectId
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  visibility    Visibility @default(PUBLIC)
  data          ProfileData?
  personIds     String[]  @default([]) @db.ObjectId
  noteIds       String[]  @default([]) @db.ObjectId
  documentIds   String[]  @default([]) @db.ObjectId
  // One-to-one relation
  person        Person?
  // One-to-many relations
  comments      Comment[]
  charts        Chart[]
}

model Note {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  content       String
  visibility    NoteVisibility @default(PRIVATE)
  userId        String    @db.ObjectId
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  date          String?   // Optional date field to associate with specific day
  comments      Comment[]
  likes         Like[]
  // Many-to-many relations (stored as arrays of IDs)
  personIds      String[]  @default([]) @db.ObjectId
  thingIds       String[]  @default([]) @db.ObjectId
  eventIds       String[]  @default([]) @db.ObjectId
  profileIds     String[]  @default([]) @db.ObjectId
  templateIds    String[]  @default([]) @db.ObjectId
  taskListIds    String[]  @default([]) @db.ObjectId
  documentIds    String[]  @default([]) @db.ObjectId
  chartIds       String[]  @default([]) @db.ObjectId
}

model Comment {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  content       String
  userId        String    @db.ObjectId
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  visibility    Visibility @default(PRIVATE)
  // Entity references
  noteId        String?   @db.ObjectId
  note          Note?     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  templateId    String?   @db.ObjectId
  template      Template? @relation(fields: [templateId], references: [id], onDelete: Cascade)
  listId        String?   @db.ObjectId
  list          TaskList? @relation(fields: [listId], references: [id], onDelete: Cascade)
  profileId     String?   @db.ObjectId
  profile       Profile?  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  eventId       String?   @db.ObjectId
  event         Event?    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  likes         Like[]
  noteIds       String[]  @default([]) @db.ObjectId
}

model Like {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime  @default(now())
  entityType    String    // 'note', 'template', 'comment', etc.
  entityId      String    @db.ObjectId
  noteId        String?   @db.ObjectId // Keep for backward compatibility
  note          Note?     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  templateId    String?   @db.ObjectId
  template      Template? @relation(fields: [templateId], references: [id], onDelete: Cascade)
  commentId     String?   @db.ObjectId
  comment       Comment?  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  userId        String    @db.ObjectId
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  visibility    Visibility @default(PRIVATE)
  
  @@unique([userId, entityType, entityId])
}

type Settings {
  dailyTemplate String? @db.ObjectId
  weeklyTemplate String? @db.ObjectId
  monthsFixedIncome  String?
  monthsVariableIncome String?
  monthsNeedFixedExpenses String?
  monthsNeedVariableExpenses String?
}

type ProfileField {
  name String?
  value String?
  visibility Boolean
}

type ProfileData {
  username ProfileField?
  firstName ProfileField?
  lastName ProfileField?
  bio ProfileField?
  profilePicture ProfileField?
  charts ProfileField? // Chart ID as value
}

type Mood {
  gratitude Int
  optimism Int
  restedness Int
  tolerance Int
  selfEsteem Int
  trust Int
  text String[]
}

type Day {
  tasks Task[]
  ephemeralTasks Task[]
  earnings String
  prize String?
  profit String?
  ticker Float?
  date String
  status String
  mood Mood?
  hint String?
  persons PersonReference[]
  things ThingReference[]
  events EventReference[]
  availableBalance String?
}

type Week {
  week String
  year  Int
  tasks  Task[]
  ephemeralTasks Task[]
  earnings String
  prize String?
  profit String?
  ticker Float?
  date String
  status String
  days Day[]
  hint String?
  availableBalance String?
}

type Task {
  id String?

  name String
  categories Category[]
  area Areas
  status String
  cadence String
  times Int?
  count Int?
  localeKey String?
  persons PersonReference[]
  things ThingReference[]
  events EventReference[]
  notes NoteReference[]
  documents DocumentReference[]
  favorite Boolean?
  isEphemeral Boolean?
  createdAt String?
  completedOn String?
  completers Completer[]
  taskStatus String?
  dueDate DateTime?
  budget Float?
  visibility Visibility?
}

type Completer {
  id String  @db.ObjectId
  earnings Float?
  prize Float?
  time Int
  completedAt DateTime
}

type PersonReference {
  id String
  name String
}

type ThingReference {
  id String
  name String
}

type EventReference {
  id String
  name String
}

type NoteReference {
  id String
  content String
}

type DocumentReference {
  id String
  fileName String
  fileUrl String
}

enum Areas {
  self
  home
  social
  work
}

enum Category {
  body
  spirituality
  fun
  extra
  clean
  affection
  maintenance
  community
  growth
  work
  mind
  spirit
  social
  home
  custom
  event
}

model Template {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  visibility    Visibility @default(PRIVATE)
  role          String?   // e.g., "default.daily", "default.weekly", "custom"
  name          String?
  owners        String[]  @db.ObjectId // User IDs
  clonedBy      String[]  @default([]) @db.ObjectId // User IDs who cloned this template
  tasks         Task[]    // Array of Task objects
  taskLists     TaskList[] // TaskLists that use this template
  comments      Comment[]
  likes         Like[]
  noteIds       String[]  @default([]) @db.ObjectId
  documentIds   String[]  @default([]) @db.ObjectId
}

model TaskList {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  visibility    Visibility @default(PRIVATE)
  role          String?   // e.g., "daily.default", "weekly.default", "custom"
  name          String?
  budget        Float?
  budgetPercentage Float? @default(0) // Percentage of user's available budget allocated to this list (0-100)
  remainingBudget String? // Remaining budget after task completions
  dueDate       String?
  owners        String[]  @db.ObjectId // User IDs
  collaborators String[]  @db.ObjectId // User IDs
  managers      String[]  @db.ObjectId // User IDs
  publicUrl     String?
  ticker        String?
  progress      String?
  templateId    String?   @db.ObjectId // Reference to Template
  template      Template? @relation(fields: [templateId], references: [id])
  // Tasks that define the template for this list
  templateTasks Task[]
  // Legacy tasks field kept for backward compatibility
  tasks         Task[]
  // Ephemeral tasks scoped to this list, separated by open/closed
  // Structure: { open: Task[]; closed: Task[] }
  ephemeralTasks Json?
  // Completed tasks by year/date: { [year]: { [date]: Task[] } }
  completedTasks Json?
  noteIds       String[]  @default([]) @db.ObjectId
  documentIds   String[]  @default([]) @db.ObjectId
  comments      Comment[]
}

enum Visibility {
  PUBLIC
  PRIVATE
  FRIENDS
  CLOSE_FRIENDS
  HIDDEN
}

enum NoteVisibility {
  PRIVATE
  FRIENDS
  CLOSE_FRIENDS
  PUBLIC
  AI_ENABLED
}

enum ProfileVisibility {
  PRIVATE
  FRIENDS
  CLOSE_FRIENDS
  PUBLIC
  AI_ENABLED
}

model Chart {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  name          String?
  type          String?   // Chart type (e.g., 'line', 'bar', 'pie', etc.)
  data          Json?     // Chart data
  config        Json?     // Chart configuration
  visibility    Visibility @default(PRIVATE)
  userId        String    @db.ObjectId
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  profileId     String?   @db.ObjectId
  profile       Profile?  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  noteIds       String[]  @default([]) @db.ObjectId
  documentIds   String[]  @default([]) @db.ObjectId
}

model Document {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  fileUrl       String
  fileName      String
  fileSize      Float?
  fileFormat    String?
  fileDuration  Float?    // Optional duration for video/audio files
  visibility    Visibility @default(PRIVATE)
  owners        String[]  @db.ObjectId // User IDs
  managers      String[]  @db.ObjectId // User IDs
  collaborators String[]  @db.ObjectId // User IDs
  // Many-to-many relations (stored as arrays of IDs)
  taskListIds   String[]  @default([]) @db.ObjectId
  templateIds   String[]  @default([]) @db.ObjectId
  noteIds       String[]  @default([]) @db.ObjectId
  thingIds      String[]  @default([]) @db.ObjectId
  eventIds      String[]  @default([]) @db.ObjectId
  personIds     String[]  @default([]) @db.ObjectId
  profileIds    String[]  @default([]) @db.ObjectId
  chartIds      String[]  @default([]) @db.ObjectId
}